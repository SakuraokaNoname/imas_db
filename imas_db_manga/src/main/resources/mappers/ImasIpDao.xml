<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.db.imas.dao.ImasIpDao">

    <insert id="insertIpInfo" parameterType="ImasIP">
        INSERT INTO imas_ip (ip0,ip255,addr)
        VALUES (#{ip0},#{ip255},#{addr})
    </insert>

    <select id="selectJapanAndKoreaIP" resultType="ImasIP">
        SELECT * FROM `imas_ip` WHERE addr like "韩国%"
        UNION ALL
        SELECT * FROM `imas_ip` WHERE addr like "日本%"
    </select>

    <insert id="insertAccessIP" parameterType="ImasAccessIP">
        INSERT INTO imas_access_ip (ip,accessTime,accessAddr,isBlock)
        VALUES
        (#{ip},#{accessTime},#{accessAddr},#{isBlock})
    </insert>

    <select id="selectPrefixIP" resultType="ImasIP">
        SELECT ip0,ip255,addr FROM imas_ip
        WHERE ip0 LIKE CONCAT(#{ip},'%')
    </select>

    <!--  先排序后分组,LIMIT防止mysql优化此语句导致排序失败  -->
    <select id="selectAccessIP" resultType="ImasAccessIPDTO">
        SELECT *,COUNT(sub.ip) as accessCount FROM
        (
            SELECT * FROM `imas_access_ip`
            <where>
                <if test="isBlock != '' and isBlock != null">
                    isBlock = #{isBlock}
                </if>
            </where>
            ORDER BY accessTime DESC
            LIMIT 99999
        ) AS sub
        GROUP BY ip
        ORDER BY accessTime DESC
    </select>
</mapper>